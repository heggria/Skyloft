# PNPM Resolution Fix for Next.js Build Issues

## Problem Description
When using pnpm with Next.js 15, webpack fails to resolve PostCSS plugins during build, resulting in errors like:
```
Cannot find module 'tailwindcss'
Cannot find module 'autoprefixer'
```

This happens because pnpm uses strict dependency isolation by default, and Next.js webpack cannot find PostCSS plugins in the isolated node_modules structure.

## Root Cause
1. **pnpm's Strict Dependency Isolation**: Unlike npm/yarn, pnpm doesn't hoist all dependencies to the root node_modules
2. **Webpack Module Resolution**: Next.js webpack tries to require PostCSS plugins from its own context
3. **Missing Explicit Dependencies**: postcss-load-config was not explicitly listed in package.json

## Solutions Implemented

### 1. Created .npmrc Configuration
File: `.npmrc`
```ini
# Hoist all dependencies to node_modules root
shamefully-hoist=true

# Public hoist pattern for PostCSS and related plugins
public-hoist-pattern[]=*postcss*
public-hoist-pattern[]=*tailwindcss*
public-hoist-pattern[]=*autoprefixer*

# Auto install peer dependencies
auto-install-peers=true

# Strict peer dependencies
strict-peer-dependencies=false
```

**Why it works**:
- `shamefully-hoist=true` makes all dependencies accessible at root level
- `public-hoist-pattern` specifically hoists PostCSS-related packages
- These settings ensure webpack can resolve PostCSS plugins

### 2. Changed PostCSS Config Format
Changed from: `postcss.config.mjs` (ES Module)
To: `postcss.config.js` (CommonJS)

**Why it works**:
- CommonJS format is more compatible with pnpm's module resolution
- Better compatibility with Next.js 15 webpack configuration

### 3. Added postcss-load-config Dependency
Added to package.json devDependencies:
```json
"postcss-load-config": "^6.0.1"
```

**Why it works**:
- Makes the PostCSS configuration loader explicitly available
- Prevents resolution issues in CI/CD environments like Vercel

## Prevention Checklist

To prevent similar issues in the future:

- [ ] Always include `.npmrc` with proper hoisting configuration when using pnpm with Next.js
- [ ] Use `postcss.config.js` (CommonJS) instead of `.mjs` (ES Module)
- [ ] Explicitly add `postcss-load-config` to devDependencies
- [ ] Test builds locally with `pnpm run build` before deploying
- [ ] When adding new PostCSS plugins, add them to both package.json AND .npmrc hoist patterns

## Vercel Deployment Notes

Vercel respects the `.npmrc` file in your repository, so these settings will automatically apply to production builds. No additional Vercel configuration is needed.

## Testing the Fix

Run locally:
```bash
# Clean install
rm -rf node_modules pnpm-lock.yaml
pnpm install

# Test build
pnpm run build
```

Build should complete successfully without PostCSS/webpack errors.

## Related Issues

This fix resolves:
- Webpack CSS plugin errors
- PostCSS plugin resolution failures
- "Cannot find module" errors for tailwindcss/autoprefixer
- Vercel build failures due to missing PostCSS plugins

## Version Info

- Next.js: 15.5.9
- pnpm: 10.27.0+
- PostCSS: 8.5.6+
- Node.js: 22.10.2+
